<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Beginner PyTorch - Image Recognition Primer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../training-data/index.html"><strong aria-hidden="true">2.</strong> Training Data Generation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../training-data/basic-image-manipulation.html"><strong aria-hidden="true">2.1.</strong> Full Image Generation</a></li></ol></li><li class="chapter-item expanded "><a href="../pytorch/index.html"><strong aria-hidden="true">3.</strong> Intro to CNNs and PyTorch</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../convolution-neural-networks/convolutional-neural-networks.html"><strong aria-hidden="true">3.1.</strong> Convolutional Neural Networks</a></li><li class="chapter-item expanded "><a href="../pytorch/intro.html" class="active"><strong aria-hidden="true">3.2.</strong> Beginner PyTorch</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Image Recognition Primer</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#intro-to-pytorch" id="intro-to-pytorch">Intro to PyTorch</a></h1>
<p>From the <a href="https://pytorch.org/">PyTorch website</a>: </p>
<p><code>&quot;An open source machine learning framework that accelerates the path from research prototyping to production deployment.&quot;</code></p>
<p>While TensorFlow was the go-to machine learning framework for quite some time, 
developers of PyTorch (a Facebook platform), saw an opportunity to create a framework
that excelled in the areas where TensorFlow lacked. What the devs created is an
extremely dynamic, user friendly library which enables rapid prototyping.</p>
<p>Let's dive in to some code. We'll rely upon some of the PyTorch docs and tutorials
as they are great resources.</p>
<p>Install the CPU PyTorch package like so. If you have a GPU, you're more than welcome
to install the GPU version.</p>
<pre><code class="language-sh">python3 -m pip install torch==1.6.0+cpu torchvision==0.7.0+cpu \ 
-f https://download.pytorch.org/whl/torch_stable.html
</code></pre>
<h2><a class="header" href="#pytorch-image-classification" id="pytorch-image-classification">PyTorch Image Classification</a></h2>
<p>We'll use some built-in packages to load a classification model and perform inference,
and we'll heavily rely on
<a href="https://pytorch.org/tutorials/beginner/blitz/cifar10_tutorial.html">this</a> tutorial, but
with a couple of adaptations.</p>
<p>The package we installed above, <code>torchvision</code>, is an external package maintained by 
PyTorch devs and the open source community. It comes with a variety of items, such as
models architectures, model weights, data, and more.</p>
<pre><code class="language-python">import torch
import torchvision
from torchvision import transforms

# Define some basic transformations for loading the images. Convolutional nets tend
# to learn better when the inputs of layers are normalized (think batchnorm), so we will
# normalize our input images.
transform = transforms.Compose(
    [transforms.ToTensor(), transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5))]
)

# These are the CIFAR-10 classes:
classes = (
    &quot;plane&quot;, &quot;car&quot;, &quot;bird&quot;, &quot;cat&quot;, &quot;deer&quot;, &quot;dog&quot;, &quot;frog&quot;, &quot;horse&quot;, &quot;ship&quot;, &quot;truck&quot;
)

# Load the CIFAR-10 datasets. We have a train set which the model learns from, but we
# also need a set which the model never learns from that we use to monitor progress.
trainset = torchvision.datasets.CIFAR10(root=&quot;./data&quot;, train=True,
                                        download=True, transform=transform)
testset = torchvision.datasets.CIFAR10(root=&quot;./data&quot;, train=False,
                                       download=True, transform=transform)
</code></pre>
<p>Next, we need a method to actually load this data, i.e. some object which will open the
image files, load them into memory, and apply the transformations. In PyTorch, we use
the
<a href="https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader"><code>torch.utils.data.DataLoader</code></a>.
Internally, the dataloader calls <code>__getitem__</code> on our datasets, a method which can be
implemented for custom datasets, like in the actual UAV code.</p>
<pre><code class="language-python"># Batch size: How many images to load on each iteration.
# shuffle: Whether or not to shuffle the data. Good for training, not useful for test.
trainloader = torch.utils.data.DataLoader(trainset, batch_size=4, shuffle=True)
testloader = torch.utils.data.DataLoader(testset, batch_size=4, shuffle=False)
</code></pre>
<p>We have our data, so now we need to make a model to learn from this dataset. We'll 
define model using some of the basic building blocks discussed in the previous section.
The output of this model will be vector of length equal to the number of  classes in the
dataset. The vector values will correspond to which class the model predicts the image
belongs to.</p>
<pre><code class="language-python">net = torch.nn.Sequential(
    torch.nn.Conv2d(3, 8, 3, stride=1, padding=1),
    torch.nn.MaxPool2d(2),
    torch.nn.Conv2d(8, 16, 3, stride=1, padding=1),
    torch.nn.MaxPool2d(2),
    torch.nn.Conv2d(16, 32, 3, stride=1, padding=1),
    torch.nn.AdaptiveAvgPool2d(1),
    torch.nn.Flatten(),
    torch.nn.Linear(32, len(classes))
)   
</code></pre>
<p>OK, we have data and a model. Now we need to define the <em>loss function</em> which informs
the model how far away its predictions are from the ground truth. Cross entropy is 
typically used in multi-class classification problems. In general, think of the model
outputting a probability distribution over the given classes, and cross entropy measures
the difference between the predicted and ground truth distributions.</p>
<pre><code class="language-python3">loss_fn = torch.nn.CrossEntropyLoss()
</code></pre>
<p>The last piece to the puzzel is a method to update the weights of the model based on
what our <code>loss_fn</code> returns. In PyTorch, these are called <code>optimizers</code>. There are <em>many</em>
optimizers out there, but for simplicity, assume the optimizer simply updates a model
based on information recieved from the <code>loss_fn</code>.</p>
<pre><code class="language-python3">optimizer = torch.optim.Adam(net.parameters(), lr=1.0e-3)
</code></pre>
<p>Awesome! Now we have all the necessary building blocks to train our own classifier!</p>
<h2><a class="header" href="#classifier-training" id="classifier-training">Classifier Training</a></h2>
<p>In just a few lines of code, we will be able to train our model. We will loop over the
<code>trainloader</code> to load batches of data, perform a <em>forward pass</em> through the model, call
the <code>loss_fn</code> then pass the results through the model using <em>backpropagation</em>, and then
update the model's weights.</p>
<pre><code class="language-python3">for idx, (images, labels) in enumerate(trainloader):

    # Take this for granted, but PyTorch optimizers always keep gradient history unless
    # we manually flush it out.
    optimizer.zero_grad()

    # forward + backward + optimizer step
    outputs = net(images)
    loss = loss_fn(outputs, labels)
    loss.backward()
    optimizer.step()

    # print statistics
    running_loss += loss.item()
    if idx % 100 == 0:
        print(f&quot;Step: {idx}. Loss: {running_loss / 100}.&quot;)
        running_loss = 0.0
</code></pre>
<p>You should start to see the loss values slowly decrease as training goes on! The smaller
the loss, the better the model is doing on the <em>training data</em>.</p>
<p>We also like to monitor the model's performance on images that it does not train on.
This is called test or validation data. The code looks like so:</p>
<pre><code class="language-python3">correct = total = 0
# During training, we want PyTorch to keep a record of how values are computed, i.e., the
# inputs and outputs so we can send information back through the model. Since we are
# only testing the model here, we do not care about keeping this record of the gradients.
with torch.no_grad():
    for images, labels in testloader:
        outputs = net(images)
        _, predicted = torch.max(outputs.data, 1)
        total += labels.size(0)
        correct += (predicted == labels).sum().item()

print(f&quot;Accuracy of the network on the 10000 test images: {100 * correct / total:.4f}&quot;)
</code></pre>
<p>Hopefully, you'll see something like:
<code>Accuracy of the network on the 10000 test images: 39.5000</code>.
Not great, but we can continue training to make the model better!</p>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<p>By now, you have a basic understanding of the high-level pipeline for training a
classifier using PyTorch. We have skipped over some important aspects to training,
namely backpropogation, but this tends to be the trickiest subject for new students.
There are numerous online resources to learn more about deep learning here:</p>
<ul>
<li><a href="9http://cs231n.stanford.edu/"><code>Stanford CS231n</code></a></li>
<li><a href="https://pytorch.org/tutorials/"><code>PyTorch Tutorials</code></a></li>
<li><a href="https://www.youtube.com/channel/UCcIXc5mJsHVYTZR1maL5l9w/playlists"><code>Andrew Ng's Video Series</code></a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../convolution-neural-networks/convolutional-neural-networks.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../convolution-neural-networks/convolutional-neural-networks.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-105339892-2', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
