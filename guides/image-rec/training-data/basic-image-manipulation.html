<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Full Image Generation - Image Recognition Primer</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../training-data/index.html"><strong aria-hidden="true">2.</strong> Training Data Generation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../training-data/basic-image-manipulation.html" class="active"><strong aria-hidden="true">2.1.</strong> Full Image Generation</a></li></ol></li><li class="chapter-item expanded "><a href="../pytorch/index.html"><strong aria-hidden="true">3.</strong> Intro to CNNs and PyTorch</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../convolution-neural-networks/convolutional-neural-networks.html"><strong aria-hidden="true">3.1.</strong> Convolutional Neural Networks</a></li><li class="chapter-item expanded "><a href="../pytorch/intro.html"><strong aria-hidden="true">3.2.</strong> Beginner PyTorch</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Image Recognition Primer</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#basic-image-manipulation-and-data-generation" id="basic-image-manipulation-and-data-generation">Basic Image Manipulation and Data Generation</a></h1>
<p>Over the next couple of examples, we will walk through how we create training data for
our vision models. Roughly, we will take pre-drawn shapes, combine them with pre-defined
text, and paste the final target onto background tiles.</p>
<h2><a class="header" href="#background-preparation" id="background-preparation">Background Preparation</a></h2>
<p>First, make sure PIL is installed:</p>
<pre><code class="language-sh">python3 -m pip install pillow==7.2.0
</code></pre>
<p>Now, let's get coding.</p>
<pre><code class="language-python"># Import the PIL package.
from PIL import Image

# Open up the background image. NOTE: The path on your computer will be different.
img = Image.open(&quot;//path//to//comp_photo.jpg&quot;)

# Sanity check to make sure you have the right image.
img.show(&quot;Example Image&quot;)
</code></pre>
<p><img src="../img/background.jpg" alt="Competition Photo" /></p>
<p>Also, check the size of this image. Machine learning models are more performant on
smaller images because there is less computation. Therfore, we need to be mindful about
our input image size.</p>
<pre><code class="language-python">print(f&quot;Image width, height: {*img.size,}.&quot;)
</code></pre>
<p>We'll need to take tiles from this image to make the input more manageable for the model.
Let's make some 512 x 512 pixel tiles. This is the size we currently use for our object
detection model.</p>
<pre><code class="language-python"># Desired tile size.
tile_width = tile_height = 512

# Make a folder to save images. We use `pathlib` for most path manipulation.
import pathlib

save_dir = pathlib.Path(&quot;//path/to/output/folder&quot;).expanduser()
save_dir.mkdir(exist_ok=True, parents=True)

# Now tile up the image:
for x in range(0, img.size[0] - tile_width, tile_width):
    for y in range(0, img.size[1] - tile_height, tile_height):
        crop = img.crop((x, y, x + tile_width, y + tile_height))
        crop.save(save_dir / f&quot;crop_{x}_{y}.jpg&quot;)

print(f&quot;Generated {len(list(save_dir.glob('*.jpg')))} slices!&quot;)
</code></pre>
<p>You should see tiles in your <code>save_dir</code> folder!</p>
<h2><a class="header" href="#target-generation-setup" id="target-generation-setup">Target Generation Setup</a></h2>
<p>Now, we need to load in our artifical targets. We'll use python's
<a href="https://docs.python.org/3/library/tarfile.html"><code>tarfile</code></a> package to extract the shapes. First,
install the python module <code>requests==2.24.0</code> using <code>pip</code>.</p>
<pre><code class="language-python">import tarfile
import tempfile
import requests

# Where to download assets.
url = &quot;https://bintray.com/uavaustin/target-finder-assets/download_file?file_path=base-shapes-v1.tar.gz&quot;

# Where to save assets.
save_dir = pathlib.Path(&quot;//path/to/save/dir&quot;).expanduser()
save_dir.mkdir(exist_ok=True, parents=True)

res = requests.get(url, stream=True)

# Make a temp dir to download archive.
with tempfile.TemporaryDirectory() as d:
    tmp_file = pathlib.Path(d) / &quot;file.tar.gz&quot;
    tmp_file.write_bytes(res.raw.read())

    with tarfile.open(tmp_file) as tar:
        tar.extractall(save_dir)
</code></pre>
<p>Congrats! You now have the shapes for data generation. Let's open one of the target images.</p>
<pre><code class="language-python">shape = Image.open(&quot;//path//to//shape.jpg&quot;)

# Sanity check
shape.show(&quot;Example shape&quot;)
</code></pre>
<p><img src="../img/pentagon-01.png" alt="Target Image" /></p>
<p>Finally, we need to download the various fonts we currently use for data generation. Perform
the same steps you did to download the shapes, but use this url instead:
<code>https://bintray.com/uavaustin/target-finder-assets/download_file?file_path=fonts.tar.gz</code></p>
<h2><a class="header" href="#image-manipulation" id="image-manipulation">Image Manipulation</a></h2>
<p>Since we have the background tiles and shape images loaded, let's do some augmentation to the shape and then paste it onto the background image.</p>
<p>Let's start with rotation. PIL's rotation function will return a copy of this image, rotated the given number of degrees counter clockwise around its center. The function takes three arguments: </p>
<ul>
<li>
<p>angle: the degrees to rotate counter clockwise about the center.</p>
</li>
<li>
<p>resample: optional flag to choose which technique to use to interpolate new pixel values expand.</p>
</li>
<li>
<p>expand: If 1, the image will expand to fit the newly rotated image.</p>
</li>
</ul>
<pre><code class="language-python"># First, you must open the target image!
target = target.rotate(45)
target.show('Rotated Image')
</code></pre>
<p><img src="../img/ex_rotation.png" alt="Cropped Competition Photo" /></p>
<p>The next part of the data generation process requires pasting a letter onto the shape. Not only
must we identify the shape at competition, but also the letter or number!</p>
<pre><code class="language-python">from PIL import ImageDraw, ImageFont

# Create an drawable object which we can edit.
target_draw = ImageDraw.Draw(target)

# Use B for example
alpha = &quot;B&quot;

# Define font multiplier to shrink or grow to fit letter to target. For some shape/letter
# combinations, we must adapt the size of the letter.
font_multiplier = 0.5

# Path to font image file
font_file = save_dir / &quot;fonts/Gudea/Gudea-Bold.ttf&quot;

# Create font height based on target size and scaled by font_multiplier.
font_size = int(round(font_multiplier * target.height))

# Create font to put on target_draw.
font = ImageFont.truetype(str(font_file), font_size)

# Get width and height of the font.
w, h = target_draw.textsize(alpha, font=font)

# Get top left coordinate of where to paste alpha onto target.
x = (target.width - w) / 2
y = (target.height - h) / 2

# Set the rgb color of the alpha.
alpha_rgb = ((64, 115, 64))  # Greenish

# Finally, draw the alpha onto the target
target_draw.text((x,y), alpha, alpha_rgb, font=font)

# Rotate target 
angle = 45
rotated_image = target.rotate(angle, expand=1)
rotated_image.show(&quot;Rotated Image&quot;)
</code></pre>
<p><img src="../img/pasted.png" alt="Cropped Competition Photo" /></p>
<p>Right now, there is a white background around the target, but we want to paste just the
target onto a background slice. How can we make everything but the target <em>transparent</em>?
Luckily, we can mainpulate the alpha channel on an image. This controls the pixel
transparency value. We will set all white pixels to 0 alpha.</p>
<pre><code class="language-python">for x in range(rotated_image.width):
    for y in range(rotated_image.height):

        r, g, b, a = rotated_image.getpixel((x, y))

        if r == 255 and g == 255 and b == 255:
            rotated_image.putpixel((x, y), (0, 0, 0, 0))
</code></pre>
<p>Using PIL's <code>getbbox</code> function, the smallest bounding box around the non zero region of
the image can expressed as a tuple. We can then use this tuple to crop the image down to
just the target. </p>
<pre><code class="language-python">rotated_crop = rotated_image.crop(rotated_image.getbbox()) 
</code></pre>
<p><img src="../img/cropped.png" alt="Cropped Target" /></p>
<p>We're getting close! Let's check the size of the target.</p>
<pre><code class="language-python">rotated_image.size
&gt;&gt;&gt; (535, 535)
</code></pre>
<p>We need to downscale the target to make it more realistic on the background slice.
Remember, the background tiles slices are only 512 x 512, so let's make the shape much
smaller.</p>
<pre><code class="language-python">rotated_image = rotated_image.resize((100, 100))
</code></pre>
<p>Finally, time to paste the target onto the background. We will paste the target's top
left pixel to (20, 20) on the background. But first, open up one of the background tiles
you created!</p>
<pre><code class="language-python">paste_loc = (20, 20)
background_tile.paste(rotated_image, paste_loc, rotated_image)
background_tile.show()
</code></pre>
<p><img src="../img/background_target.jpg" alt="Background With Target" /></p>
<p>We need to save the class and location of this target for our model data generation
later. We will save the target class, the (x,y) coordinate of the top left corner,
height, and width. </p>
<pre><code class="language-python">w_target, h_target = rotated_image.size
txt = pathlib.Path(&quot;background_target.txt&quot;)
txt.write_text(
    f&quot;pentagon, {int(paste_loc[0])}, {int(paste_loc[1])}, {w_target}, {h_target}\n&quot;
)
</code></pre>
<p>The output <code>background_target.txt</code> file should have the single following line:</p>
<p><code>pentagon, 20, 20, 100, 100</code></p>
<p>You've now gone through the basic pipeline of how we create our data for the models. Data
is by far the most important aspect of machine learning.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../training-data/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../pytorch/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../training-data/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../pytorch/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-105339892-2', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
